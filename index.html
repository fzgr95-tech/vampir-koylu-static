<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vampir K√∂yl√º</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0f0c29;
            --primary-color: #00d4ff;
            --secondary-color: #ff0055;
            --accent-color: #7000ff;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-radius: 16px;
            --font-main: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text-color);
            font-family: var(--font-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            width: 100%;
            overflow-x: hidden;
        }

        body.shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .container {
            width: 100%;
            max-width: 480px;
            padding: 20px;
            margin: 0 auto;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .screen.active {
            display: flex;
        }

        h1.game-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-action {
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .btn-text {
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: underline;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: var(--card-radius);
            width: 100%;
            margin-top: 15px;
        }

        .hidden {
            display: none !important;
        }

        .players-list {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .player-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            min-width: 100px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            background: var(--accent-color);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .role-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
            border: 1px solid;
            background: rgba(0, 0, 0, 0.3);
        }

        .role-vampire {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .role-villager {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .role-doctor {
            color: #00ff64;
            border-color: #00ff64;
        }

        .role-seer {
            color: #b400ff;
            border-color: #b400ff;
        }

        .role-traitor {
            color: #ff9600;
            border-color: #ff9600;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .phase-indicator {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .countdown {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .countdown-urgent {
            color: var(--secondary-color);
        }

        .chat-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            margin-top: 15px;
            width: 100%;
        }

        .chat-messages {
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .chat-message {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input-area input {
            flex: 1;
            margin-bottom: 0;
        }

        .chat-input-area button {
            width: auto;
            padding: 12px 20px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .toast.error {
            border-color: var(--secondary-color);
        }

        .toast.chaos {
            border-color: #ff9600;
        }

        .night-mode {
            background: #000 !important;
        }

        .night-mode .container {
            background: rgba(50, 0, 0, 0.3);
        }

        .vote-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .vote-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .vote-card.is-dead {
            opacity: 0.4;
            pointer-events: none;
        }

        .chaos-banner {
            background: rgba(255, 150, 0, 0.2);
            border: 1px solid #ff9600;
            color: #ff9600;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                border-color: #ff9600;
                box-shadow: 0 0 5px #ff9600;
            }

            50% {
                border-color: #ff0000;
                box-shadow: 0 0 15px #ff0000;
            }

            100% {
                border-color: #ff9600;
                box-shadow: 0 0 5px #ff9600;
            }
        }

        #duel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #duel-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 5px solid white;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            animation: pulse-fast 0.5s infinite;
        }

        @keyframes pulse-fast {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(0, 212, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 212, 255, 0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ANA EKRAN -->
        <div id="screen-home" class="screen active">
            <h1 class="game-title">üßõ VAMPƒ∞R K√ñYL√ú<br><small style="font-size:1rem;color:#aaa">ULTIMATE EDITION</small>
            </h1>

            <div class="form-section">
                <input type="text" id="username-input" placeholder="Kullanƒ±cƒ± Adƒ±n">

                <button class="btn btn-primary" onclick="showCreateRoom()">üè† Oda Kur</button>
                <button class="btn btn-secondary" onclick="showJoinRoom()">üö™ Odaya Katƒ±l</button>
            </div>

            <!-- Aktif Odalar Listesi -->
            <div id="room-list-container" class="form-section" style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px; font-size: 1.1rem;">üî• Aktif Odalar</h3>
                <div id="active-rooms-list" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">Oda aranƒ±yor...</p>
                </div>
            </div>

            <!-- Oda Kurma -->
            <div id="create-form" class="form-section hidden">
                <h3 style="margin-bottom: 15px;">Oda Olu≈ütur</h3>
                <input type="text" id="room-name-input" placeholder="Oda ƒ∞smi">
                <input type="password" id="room-password-input" placeholder="≈ûifre (ƒ∞steƒüe Baƒülƒ±)">
                <input type="number" id="vampire-count-input" value="1" min="1" max="3" placeholder="Vampir Sayƒ±sƒ±">
                <input type="number" id="duration-input" value="60" min="30" max="180"
                    placeholder="Tartƒ±≈üma S√ºresi (sn)">
                <input type="number" id="vote-duration-input" value="30" min="10" max="120"
                    placeholder="Oylama S√ºresi (sn)">

                <!-- Rol Se√ßimi -->
                <div style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <p style="margin-bottom: 10px; font-weight: bold;">üé≠ √ñzel Roller:</p>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-doctor" checked style="width: auto;">
                        <span>üíâ Doktor (Geceleri korur)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-seer" checked style="width: auto;">
                        <span>üîÆ Medyum (Geceleri sorgular)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-traitor" style="width: auto;">
                        <span>üêÄ K√∂stebek (Vampirlerle √ßalƒ±≈üƒ±r)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-hunter" style="width: auto;">
                        <span>üèπ Avcƒ± (√ñl√ºrken birini g√∂t√ºr√ºr)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-witch" style="width: auto;">
                        <span>‚ú® B√ºy√ºc√º (1x kurtarma + 1x zehir)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="role-sheriff" style="width: auto;">
                        <span>‚≠ê ≈ûerif (Oyu 2 sayƒ±lƒ±r)</span>
                    </label>
                </div>

                <!-- ƒ∞ttifak Sistemi -->
                <div style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="enable-alliance" style="width: auto;">
                        <span>ü§ù <strong>ƒ∞ttifak Sistemi</strong></span>
                    </label>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 8px;">
                        Oyuncular grup kurabilir. Gruptaki biri √∂l√ºrse hepsi √∂l√ºr!
                    </p>
                </div>

                <button class="btn btn-action" onclick="createRoom()">Olu≈ütur</button>
                <button class="btn btn-text" onclick="hideCreateRoom()">ƒ∞ptal</button>
            </div>

            <!-- Odaya Katƒ±lma -->
            <div id="join-form" class="form-section hidden">
                <h3 style="margin-bottom: 15px;">Odaya Katƒ±l</h3>
                <input type="text" id="room-code-input" placeholder="Oda Kodu">
                <input type="password" id="join-password-input" placeholder="≈ûifre (Varsa)">
                <button class="btn btn-action" onclick="joinRoom()">Katƒ±l</button>
                <button class="btn btn-text" onclick="hideJoinRoom()">ƒ∞ptal</button>
            </div>
        </div>

        <!-- LOBƒ∞ EKRANI -->
        <div id="screen-lobby" class="screen">
            <h2 style="text-align: center; margin-bottom: 10px;" id="lobby-title">Lobi</h2>
            <p style="text-align: center; margin-bottom: 20px;">
                Oda Kodu: <strong id="room-code-display" style="color: var(--primary-color);"></strong>
                <button onclick="copyRoomCode()"
                    style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1rem;">üìã</button>
            </p>

            <div class="players-list" id="lobby-players"></div>

            <div id="host-controls" class="hidden" style="width: 100%;">
                <button class="btn btn-primary pulse" onclick="startGame()">üéÆ Oyunu Ba≈ülat</button>
            </div>

            <button class="btn btn-text" onclick="leaveLobby()">‚Üê √áƒ±k</button>

            <!-- Lobi Sohbet -->
            <div class="chat-container">
                <h4 style="margin-bottom: 10px;">üí¨ Sohbet</h4>
                <div id="lobby-chat" class="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="lobby-chat-input" placeholder="Mesaj yaz..."
                        onkeypress="if(event.key==='Enter') sendLobbyChat()">
                    <button class="btn btn-primary" onclick="sendLobbyChat()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- OYUN EKRANI -->
        <div id="screen-game" class="screen">
            <div class="game-header">
                <div class="role-badge" id="role-badge">?</div>
                <div class="phase-indicator" id="phase-display">G√ºnd√ºz</div>
                <div class="countdown" id="countdown">60</div>
            </div>

            <div id="chaos-banner" class="chaos-banner"></div>

            <div id="game-message" style="text-align: center; margin-bottom: 15px; font-size: 1.1rem;"></div>

            <div class="vote-grid" id="players-grid"></div>

            <div id="night-action-panel" class="form-section hidden">
                <h3 id="night-action-title">Gece Aksiyonu</h3>
                <p id="night-action-desc" style="margin-bottom: 15px;"></p>
                <div id="night-targets" class="vote-grid"></div>
            </div>

            <!-- ƒ∞ttifak Paneli -->
            <div id="alliance-panel" class="form-section hidden">
                <h3>ü§ù ƒ∞ttifak</h3>
                <div id="alliance-status" style="margin-bottom: 10px; font-size: 0.9rem;"></div>
                <div id="alliance-invite-pending" class="hidden"
                    style="background: rgba(255,150,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p id="alliance-invite-text"></p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="acceptAllianceInvite()">‚úì Kabul</button>
                        <button class="btn btn-secondary" onclick="rejectAllianceInvite()">‚úó Reddet</button>
                    </div>
                </div>
                <div id="alliance-actions">
                    <button class="btn btn-secondary" onclick="showAllianceInvitePanel()" id="btn-invite-alliance">üë•
                        Davet G√∂nder</button>
                    <button class="btn btn-text hidden" onclick="leaveAlliance()" id="btn-leave-alliance">üö™ Gruptan
                        Ayrƒ±l</button>
                </div>
                <div id="alliance-invite-panel" class="hidden" style="margin-top: 10px;">
                    <p style="margin-bottom: 10px;">Kimi davet etmek istiyorsun?</p>
                    <div id="alliance-invite-targets" class="vote-grid"></div>
                </div>
            </div>

            <div id="dead-controls" class="form-section hidden">
                <h3>üëª Hayalet Modu</h3>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="haunt('vibrate')">üì≥ Titret</button>
                    <button class="btn btn-secondary" onclick="haunt('jumpscare')">üëÅÔ∏è Korkut</button>
                </div>
            </div>

            <!-- Oyun Sohbet -->
            <div class="chat-container">
                <div id="game-chat" class="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="game-chat-input" placeholder="Mesaj yaz..."
                        onkeypress="if(event.key==='Enter') sendGameChat()">
                    <button class="btn btn-primary" onclick="sendGameChat()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- OYUN SONU EKRANI -->
        <div id="screen-end" class="screen">
            <h1 id="end-title" style="font-size: 2rem; text-align: center; margin-bottom: 20px;"></h1>
            <p id="end-message" style="text-align: center; margin-bottom: 30px;"></p>
            <button class="btn btn-primary" onclick="backToHome()">Ana Men√ºye D√∂n</button>
        </div>

        <!-- DUEL OVERLAY -->
        <div id="duel-overlay" class="hidden">
            <h2 style="color: white; margin-bottom: 20px;">D√úELLO!</h2>
            <button id="duel-btn" onclick="duelClick()">TIKLA!</button>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // ========== GLOBAL STATE ==========
        let peer = null;
        let connections = {};
        let isHost = false;
        let myPeerId = null;
        let myUsername = '';
        let roomCode = '';
        let hostConnection = null;

        // Lobby System
        let lobbyConnection = null;
        let isLobbyManager = false;
        // G√ºnl√ºk ID deƒüi≈üimi basit √ß√∂z√ºm (Herkes aynƒ± g√ºn aynƒ± lobiye d√º≈üecek)
        const LOBBY_ID = 'vampir-koylu-master-lobby-' + new Date().getDate();

        let gameState = {
            phase: 'lobby',
            players: {},
            vampireCount: 1,
            duration: 60,
            voteDuration: 30,
            roomName: '',
            password: '',
            nightActions: {},
            countdown: 60,
            chaosEvent: null,
            duelScores: {},
            hunterTarget: null,
            witchPotions: { heal: true, poison: true },
            // ƒ∞ttifak sistemi
            allianceEnabled: false,
            alliances: {}, // { allianceId: [playerId1, playerId2, ...] }
            allianceInvites: {}, // { targetPlayerId: { from: playerId, allianceId: id } }
            nextAllianceId: 1,
            // Dinamik rol ayarlarƒ±
            roles: {
                doctor: true,
                seer: true,
                traitor: false,
                hunter: false,
                witch: false,
                sheriff: false
            }
        };

        let countdownInterval = null;

        // ========== UTILITIES ==========
        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode);
            showToast('Oda kodu kopyalandƒ±!');
        }

        // ========== PEER CONNECTION ==========
        async function initApp() {
            await initPeer();
            connectToLobby();
        }

        function initPeer(id = null) {
            return new Promise((resolve, reject) => {
                const config = {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                };
                peer = id ? new Peer(id, config) : new Peer(config);

                peer.on('open', (peerId) => {
                    myPeerId = peerId;
                    console.log('My ID:', peerId);
                    resolve(peerId);
                });

                peer.on('connection', (conn) => {
                    handleNewConnection(conn);
                });

                peer.on('error', (err) => {
                    console.log('Peer error:', err.type);
                    if (err.type === 'unavailable-id') {
                        if (id === LOBBY_ID) connectToLobby();
                        else showToast('Bu oda kodu kullanƒ±mda!', 'error');
                    }
                    // reject(err); 
                });
            });
        }

        // LOBBY LOGIC
        function connectToLobby() {
            if (myPeerId === LOBBY_ID) return;

            const conn = peer.connect(LOBBY_ID);

            conn.on('open', () => {
                console.log('Connected to Lobby');
                lobbyConnection = conn;
                conn.send({ type: 'get_rooms' });
                conn.on('data', (data) => {
                    if (data.type === 'room_list') updateRoomListUI(data.rooms);
                });
            });

            conn.on('error', () => {
                becomeLobbyManager();
            });

            setTimeout(() => {
                if (!lobbyConnection && !isLobbyManager) becomeLobbyManager();
            }, 3000);
        }

        async function becomeLobbyManager() {
            if (isLobbyManager) return;
            if (peer) peer.destroy();

            try {
                await initPeer(LOBBY_ID);
                isLobbyManager = true;
                console.log('I am Lobby Manager');
                showToast('Lobi Y√∂neticisi Oldun!', 'info');
                updateRoomListUI(knownRooms);
            } catch (e) {
                initPeer();
                setTimeout(connectToLobby, 2000);
            }
        }

        let knownRooms = {};

        function handleLobbyMessage(conn, data) {
            if (data.type === 'register_room') {
                knownRooms[data.code] = data.info;
                broadcastRooms();
            } else if (data.type === 'get_rooms') {
                conn.send({ type: 'room_list', rooms: knownRooms });
            }
        }

        function broadcastRooms() {
            Object.values(connections).forEach(c => {
                if (c.open) c.send({ type: 'room_list', rooms: knownRooms });
            });
        }

        function updateRoomListUI(rooms) {
            const list = document.getElementById('active-rooms-list');
            list.innerHTML = '';

            const roomKeys = Object.keys(rooms);
            if (roomKeys.length === 0) {
                list.innerHTML = '<p style="opacity:0.6;font-size:0.9rem;">Aktif oda yok.</p>';
                return;
            }

            roomKeys.forEach(code => {
                const r = rooms[code];
                const div = document.createElement('div');
                div.style.background = 'rgba(255,255,255,0.1)';
                div.style.padding = '10px';
                div.style.borderRadius = '8px';
                div.style.marginBottom = '5px';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.cursor = 'pointer';
                div.onclick = () => {
                    document.getElementById('room-code-input').value = code;
                    showJoinRoom();
                };

                div.innerHTML = `<div><strong>${r.name}</strong> ${r.locked ? 'üîí' : ''}<br><small style="color:#aaa">${code}</small></div>`;
                list.appendChild(div);
            });
        }

        function handleNewConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                conn.on('data', (data) => {
                    if (isLobbyManager) handleLobbyMessage(conn, data);
                    else handleMessage(conn.peer, data);
                });
                conn.on('close', () => handleDisconnect(conn.peer));
            });
        }

        function handleDisconnect(peerId) {
            delete connections[peerId];
            if (isHost && gameState.players[peerId]) {
                delete gameState.players[peerId];
                broadcastState();
            }
        }

        function broadcast(data) {
            Object.values(connections).forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        function sendToHost(data) {
            if (hostConnection && hostConnection.open) {
                hostConnection.send(data);
            }
        }

        function handleMessage(fromPeerId, data) {
            switch (data.type) {
                case 'join':
                    if (isHost) {
                        // ≈ûifre Kontrol√º
                        if (gameState.password && gameState.password !== data.password) {
                            const conn = connections[fromPeerId];
                            if (conn) {
                                conn.send({ type: 'chat', sender: 'Sƒ∞STEM', message: 'Hatalƒ± ≈ûifre! Baƒülantƒ± kesiliyor...', chatType: 'lobby' });
                                setTimeout(() => conn.close(), 1000);
                            }
                            return;
                        }

                        gameState.players[fromPeerId] = {
                            name: data.username,
                            role: null,
                            isAlive: true,
                            vote: null
                        };
                        broadcastState();
                    }
                    break;

                // --- ALLIANCE EVENTS (Host Only) ---
                case 'alliance_invite':
                    if (isHost && gameState.allianceEnabled) {
                        const myAlliance = getMyAllianceForPlayer(fromPeerId);
                        const allianceId = myAlliance ? myAlliance.id : gameState.nextAllianceId;

                        if (!myAlliance) {
                            gameState.alliances[allianceId] = [fromPeerId];
                            gameState.nextAllianceId++;
                        }

                        gameState.allianceInvites[data.target] = { from: fromPeerId, allianceId: allianceId };
                        broadcastState();
                    }
                    break;

                case 'alliance_accept':
                    if (isHost && gameState.allianceEnabled) {
                        const invite = gameState.allianceInvites[fromPeerId];
                        if (invite) {
                            if (!gameState.alliances[invite.allianceId]) {
                                gameState.alliances[invite.allianceId] = [invite.from];
                            }
                            gameState.alliances[invite.allianceId].push(fromPeerId);
                            delete gameState.allianceInvites[fromPeerId];
                            broadcastState();
                        }
                    }
                    break;

                case 'alliance_reject':
                    if (isHost && gameState.allianceEnabled) {
                        delete gameState.allianceInvites[fromPeerId];
                        broadcastState();
                    }
                    break;

                case 'alliance_leave':
                    if (isHost && gameState.allianceEnabled) {
                        const alliance = getMyAllianceForPlayer(fromPeerId);
                        if (alliance) {
                            const idx = gameState.alliances[alliance.id].indexOf(fromPeerId);
                            if (idx > -1) gameState.alliances[alliance.id].splice(idx, 1);
                            if (gameState.alliances[alliance.id].length === 0) {
                                delete gameState.alliances[alliance.id];
                            }
                            broadcastState();
                        }
                    }
                    break;

                case 'state':
                    gameState = data.state;
                    updateUI();
                    break;

                case 'chat':
                    addChatMessage(data.sender, data.message, data.chatType, data.isGhost);
                    if (isHost) broadcast(data);
                    break;

                case 'notification':
                    showToast(data.message, data.urgency === 'high' ? 'error' : 'info');
                    if (data.urgency === 'high' && navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    break;

                case 'vote':
                    if (isHost) {
                        gameState.players[fromPeerId].vote = data.target;
                        checkAllVoted();
                    }
                    break;

                case 'night_action':
                    if (isHost) {
                        gameState.nightActions[fromPeerId] = { action: data.action, target: data.target };
                        checkAllNightActions();
                    }
                    break;

                case 'haunt':
                    if (isHost) broadcast({ type: 'haunt_effect', effect: data.effect });
                    break;

                case 'haunt_effect':
                    triggerHauntEffect(data.effect);
                    break;

                case 'duel_start':
                    showDuelOverlay();
                    break;

                case 'duel_click':
                    if (isHost) {
                        gameState.duelScores[fromPeerId] = (gameState.duelScores[fromPeerId] || 0) + 1;
                    }
                    break;

                case 'hunter_revenge':
                    if (isHost && data.target) {
                        gameState.players[data.target].isAlive = false;
                        killAllianceMembers(data.target); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                        const targetName = gameState.players[data.target].name;
                        const targetRole = gameState.players[data.target].role;
                        document.getElementById('game-message').innerText += ` üèπ Avcƒ± ${targetName}'i beraberinde g√∂t√ºrd√º! (${getRoleEmoji(targetRole)})`;
                        broadcastState();
                        if (!checkWin()) setTimeout(() => startNightPhase(), 3000);
                    }
                    break;

                case 'game_start':
                    showScreen('game');
                    break;

                case 'game_end':
                    showEndScreen(data.winner, data.message);
                    break;
            }
        }

        function broadcastState() {
            broadcast({ type: 'state', state: gameState });
            updateUI();
        }

        // ========== ROOM & GAME LOGIC ==========
        async function createRoom() {
            myUsername = document.getElementById('username-input').value.trim();
            if (!myUsername) return showToast('ƒ∞sim gir!', 'error');

            roomCode = generateRoomCode();
            gameState.roomName = document.getElementById('room-name-input').value || 'Oda ' + roomCode;
            gameState.password = document.getElementById('room-password-input').value.trim();
            gameState.vampireCount = parseInt(document.getElementById('vampire-count-input').value);
            gameState.duration = parseInt(document.getElementById('duration-input').value);
            gameState.voteDuration = parseInt(document.getElementById('vote-duration-input').value) || 30;

            // Rol ayarlarƒ±nƒ± kaydet
            gameState.roles = {
                doctor: document.getElementById('role-doctor').checked,
                seer: document.getElementById('role-seer').checked,
                traitor: document.getElementById('role-traitor').checked,
                hunter: document.getElementById('role-hunter').checked,
                witch: document.getElementById('role-witch').checked,
                sheriff: document.getElementById('role-sheriff').checked
            };

            // B√ºy√ºc√º iksirlerini sƒ±fƒ±rla
            gameState.witchPotions = { heal: true, poison: true };

            // ƒ∞ttifak sistemi
            gameState.allianceEnabled = document.getElementById('enable-alliance').checked;
            gameState.alliances = {};
            gameState.allianceInvites = {};
            gameState.nextAllianceId = 1;

            try {
                // If I was manager, stop being manager
                if (isLobbyManager) {
                    isLobbyManager = false;
                    if (peer) peer.destroy();
                }

                await initPeer(roomCode);
                isHost = true;
                gameState.players[myPeerId] = { name: myUsername, role: null, isAlive: true, vote: null };

                // Register to Lobby
                const conn = peer.connect(LOBBY_ID);
                conn.on('open', () => {
                    conn.send({
                        type: 'register_room',
                        code: roomCode,
                        info: { name: gameState.roomName, locked: !!gameState.password }
                    });
                });

                document.getElementById('room-code-display').innerText = roomCode;
                document.getElementById('lobby-title').innerText = gameState.roomName;
                document.getElementById('host-controls').classList.remove('hidden');

                showScreen('lobby');
                updateLobbyPlayers();
                showToast('Oda kuruldu: ' + roomCode);
            } catch (err) { console.error(err); }
        }

        async function joinRoom() {
            myUsername = document.getElementById('username-input').value.trim();
            roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            const password = document.getElementById('join-password-input').value.trim();

            if (!myUsername || !roomCode) return showToast('Bilgileri gir!', 'error');

            try {
                await initPeer();
                hostConnection = peer.connect(roomCode);

                hostConnection.on('open', () => {
                    connections[roomCode] = hostConnection;
                    hostConnection.send({ type: 'join', username: myUsername, password: password });

                    hostConnection.on('data', d => handleMessage(roomCode, d));
                    document.getElementById('room-code-display').innerText = roomCode;
                    showScreen('lobby');
                });
                hostConnection.on('error', () => showToast('Baƒülantƒ± hatasƒ±!', 'error'));
            } catch (err) { console.error(err); }
        }

        function startGame() {
            if (!isHost) return;
            const pIds = Object.keys(gameState.players);
            if (pIds.length < gameState.vampireCount + 2) return showToast('Yetersiz oyuncu!', 'error');

            // Roles - Dinamik rol daƒüƒ±tƒ±mƒ±
            let roles = [];
            for (let i = 0; i < gameState.vampireCount; i++) roles.push('vampire');

            // Sadece se√ßili roller eklenir
            if (gameState.roles.doctor) roles.push('doctor');
            if (gameState.roles.seer) roles.push('seer');
            if (gameState.roles.traitor) roles.push('traitor');
            if (gameState.roles.hunter) roles.push('hunter');
            if (gameState.roles.witch) roles.push('witch');
            if (gameState.roles.sheriff) roles.push('sheriff');

            // Kalan herkes k√∂yl√º
            while (roles.length < pIds.length) roles.push('villager');

            // Shuffle
            roles = roles.sort(() => Math.random() - 0.5);

            pIds.forEach((id, i) => {
                gameState.players[id].role = roles[i];
                gameState.players[id].isAlive = true;
                gameState.players[id].vote = null;
            });

            broadcast({ type: 'game_start' });
            showScreen('game');
            startDayPhase();
        }

        function startDayPhase() {
            gameState.phase = 'day';
            gameState.countdown = gameState.duration;
            gameState.chaosEvent = null;

            // Chaos Event (%50 ≈üans)
            const events = [
                { id: 'blind', name: 'üôà K√ñR ADALET', desc: 'Oylar gizli olacak!' },
                { id: 'silence', name: 'ü§ê SESSƒ∞ZLƒ∞K', desc: 'Konu≈ümak yasak!' },
                { id: 'double', name: '‚ö° √áƒ∞FTE BELA', desc: 'ƒ∞ki ki≈üi asƒ±lacak!' }
            ];

            if (Math.random() > 0.5) {
                gameState.chaosEvent = events[Math.floor(Math.random() * events.length)];
            }

            broadcastState();
            startCountdown(() => startVotingPhase());
        }

        function startVotingPhase() {
            gameState.phase = 'voting';
            gameState.countdown = gameState.voteDuration || 30;
            Object.values(gameState.players).forEach(p => p.vote = null);
            broadcastState();
            broadcast({ type: 'notification', message: `‚ö†Ô∏è OYLAMA BA≈ûLADI! ${gameState.countdown} saniyeniz var!`, urgency: 'high' });
            startCountdown(() => resolveVotes());
        }

        function startNightPhase() {
            gameState.phase = 'night';
            gameState.nightActions = {};
            gameState.countdown = 30;
            broadcastState();
            startCountdown(() => resolveNight());
        }

        function startCountdown(cb) {
            if (countdownInterval) clearInterval(countdownInterval);

            // Initial sync
            if (isHost) broadcastState();

            countdownInterval = setInterval(() => {
                gameState.countdown--;

                // UPDATE UI FOR EVERYONE (Client-side prediction)
                const cdEl = document.getElementById('countdown');
                if (cdEl) cdEl.innerText = gameState.countdown;

                if (isHost) {
                    // Broadcast every second for better sync in P2P
                    broadcastState();

                    // Warning near end
                    if (gameState.countdown === 10) {
                        broadcast({ type: 'notification', message: '‚è≥ Son 10 Saniye!', urgency: 'medium' });
                    }
                }

                if (gameState.countdown <= 0) {
                    clearInterval(countdownInterval);
                    if (cb) cb();
                }
            }, 1000);
        }

        function castVote(targetId) {
            const me = gameState.players[myPeerId];
            if (!me.isAlive) return;

            if (isHost) {
                me.vote = targetId;
                checkAllVoted();
            } else {
                sendToHost({ type: 'vote', target: targetId });
            }
            showToast('Oy verildi!');
            // Disable buttons
            document.querySelectorAll('.vote-card').forEach(b => b.style.pointerEvents = 'none');
        }

        function checkAllVoted() {
            const alive = Object.values(gameState.players).filter(p => p.isAlive);
            const voted = alive.filter(p => p.vote);
            if (voted.length >= alive.length) resolveVotes();
        }

        function resolveVotes() {
            clearInterval(countdownInterval);
            const votes = {};

            // Oylarƒ± say - ≈ûerif 2x oy g√ºc√ºne sahip
            Object.entries(gameState.players).forEach(([id, p]) => {
                if (p.isAlive && p.vote) {
                    const voteWeight = (p.role === 'sheriff') ? 2 : 1;
                    votes[p.vote] = (votes[p.vote] || 0) + voteWeight;
                }
            });

            // Logic for max votes
            let max = 0;
            let victims = [];
            Object.entries(votes).forEach(([id, c]) => {
                if (c > max) { max = c; victims = [id]; }
                else if (c === max) victims.push(id);
            });

            let msg = '';
            let hunterTriggered = false;
            let hunterVictimId = null;

            if (victims.length === 1) {
                const victimId = victims[0];
                const v = gameState.players[victimId];
                v.isAlive = false;
                killAllianceMembers(victimId); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                msg = `‚ö∞Ô∏è ${v.name} asƒ±ldƒ±! Rol√º: ${getRoleEmoji(v.role)} ${v.role.toUpperCase()}`;

                // Avcƒ± √∂ld√ºyse hedef se√ßmesi gerekiyor
                if (v.role === 'hunter') {
                    hunterTriggered = true;
                    hunterVictimId = victimId;
                }
            } else {
                msg = '‚öñÔ∏è Oylar e≈üit, kimse asƒ±lmadƒ±.';
                if (gameState.chaosEvent?.id === 'double' && victims.length === 2) {
                    victims.forEach(id => {
                        const v = gameState.players[id];
                        v.isAlive = false;
                        killAllianceMembers(id); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                        if (v.role === 'hunter') {
                            hunterTriggered = true;
                            hunterVictimId = id;
                        }
                    });
                    msg = `‚ö° √áƒ∞FTE BELA! ${gameState.players[victims[0]].name} ve ${gameState.players[victims[1]].name} asƒ±ldƒ±!`;
                }
            }

            document.getElementById('game-message').innerText = msg;
            broadcastState();

            // Avcƒ± √∂ld√ºyse hedef se√ßtir
            if (hunterTriggered && hunterVictimId === myPeerId) {
                showHunterRevenge();
            } else if (!checkWin()) {
                setTimeout(() => startNightPhase(), 4000);
            }
        }

        // Avcƒ± intikamƒ± - √∂l√ºrken birini se√ßer
        function showHunterRevenge() {
            const panel = document.getElementById('night-action-panel');
            panel.classList.remove('hidden');
            document.getElementById('night-action-title').innerText = 'üèπ AVCI ƒ∞NTƒ∞KAMI';
            document.getElementById('night-action-desc').innerText = '√ñlmeden √∂nce birini se√ß!';

            const targetsDiv = document.getElementById('night-targets');
            targetsDiv.innerHTML = '';

            Object.entries(gameState.players).forEach(([id, p]) => {
                if (!p.isAlive || id === myPeerId) return;
                const btn = document.createElement('div');
                btn.className = 'vote-card';
                btn.innerHTML = p.name;
                btn.style.padding = '10px';
                btn.onclick = () => {
                    // Hedefi √∂ld√ºr
                    if (isHost) {
                        gameState.players[id].isAlive = false;
                        killAllianceMembers(id); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                        const targetName = gameState.players[id].name;
                        const targetRole = gameState.players[id].role;
                        document.getElementById('game-message').innerText += ` üèπ Avcƒ± ${targetName}'i beraberinde g√∂t√ºrd√º! (${getRoleEmoji(targetRole)})`;
                        broadcastState();
                        panel.classList.add('hidden');
                        if (!checkWin()) setTimeout(() => startNightPhase(), 3000);
                    } else {
                        sendToHost({ type: 'hunter_revenge', target: id });
                        panel.classList.add('hidden');
                    }
                };
                targetsDiv.appendChild(btn);
            });
        }

        function resolveNight() {
            clearInterval(countdownInterval);
            // Logic: Vampire kills, Doctor protects, Witch heals/poisons, Seer inspected locally
            const kills = [];
            const protects = [];
            let witchHeal = false;
            let witchPoison = null;

            Object.values(gameState.nightActions).forEach(a => {
                if (a.action === 'kill') kills.push(a.target);
                if (a.action === 'protect') protects.push(a.target);
                if (a.action === 'witch_heal') witchHeal = true;
                if (a.action === 'witch_poison') witchPoison = a.target;
            });

            let victim = kills[0]; // Simplification: 1 kill
            let msg = 'üåô Gece sessiz ge√ßti.';
            let deaths = [];

            // Vampir saldƒ±rƒ±sƒ±
            if (victim) {
                // Doktor veya B√ºy√ºc√º kurtardƒ± mƒ±?
                if (protects.includes(victim)) {
                    msg = 'üíâ Doktor m√ºdahalesi hayat kurtardƒ±!';
                } else if (witchHeal) {
                    msg = '‚ú® B√ºy√ºc√º iksiri hayat kurtardƒ±!';
                } else {
                    const p = gameState.players[victim];
                    p.isAlive = false;
                    killAllianceMembers(victim); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                    deaths.push(p.name);
                }
            }

            // B√ºy√ºc√º zehiri
            if (witchPoison && gameState.players[witchPoison]) {
                const poisoned = gameState.players[witchPoison];
                poisoned.isAlive = false;
                killAllianceMembers(witchPoison); // ƒ∞ttifak arkada≈ülarƒ±nƒ± da √∂ld√ºr
                deaths.push(poisoned.name + ' (zehirlendi)');
            }

            // Mesajƒ± olu≈ütur
            if (deaths.length > 0) {
                msg = `üíÄ ${deaths.join(' ve ')} √∂l√º bulundu!`;
            }

            document.getElementById('game-message').innerText = msg;
            broadcastState();

            // Avcƒ± gece √∂ld√ºr√ºld√ºyse intikam alabilir
            let hunterDied = false;
            let hunterVictimId = null;

            // Vampir kurbanƒ± Avcƒ± mƒ± kontrol et
            if (victim && gameState.players[victim] && !gameState.players[victim].isAlive && gameState.players[victim].role === 'hunter') {
                hunterDied = true;
                hunterVictimId = victim;
            }
            // Zehirlenen Avcƒ± mƒ± kontrol et
            if (witchPoison && gameState.players[witchPoison] && gameState.players[witchPoison].role === 'hunter') {
                hunterDied = true;
                hunterVictimId = witchPoison;
            }

            if (hunterDied && hunterVictimId === myPeerId) {
                showHunterRevenge();
            } else if (!checkWin()) {
                setTimeout(() => startDayPhase(), 4000);
            }
        }

        function checkWin() {
            const alive = Object.values(gameState.players).filter(p => p.isAlive);
            const vamps = alive.filter(p => p.role === 'vampire');
            const norms = alive.filter(p => p.role !== 'vampire'); // Traitor counts as norm for survival but helps vamps?

            // Usually win if Vamps >= Norms
            if (vamps.length === 0) {
                endGame('villagers', 'K√∂yl√ºler kazandƒ±! Vampirler temizlendi.');
                return true;
            }
            if (vamps.length >= norms.length) {
                endGame('vampires', 'Vampirler k√∂y√º ele ge√ßirdi!');
                return true;
            }
            return false;
        }

        function endGame(winner, msg) {
            broadcast({ type: 'game_end', winner, message: msg });
            showEndScreen(winner, msg);
        }

        // ========== CLIENT UI ==========
        function updateUI() {
            if (gameState.phase === 'lobby') {
                updateLobbyPlayers();
                return;
            }
            // Game UI
            const me = gameState.players[myPeerId];
            if (!me) return;

            // Header
            document.getElementById('role-badge').innerText = getRoleEmoji(me.role) + ' ' + me.role.toUpperCase();
            document.getElementById('role-badge').className = `role-badge role-${me.role}`;
            document.getElementById('phase-display').innerText = gameState.phase === 'day' ? '‚òÄÔ∏è G√úND√úZ' : (gameState.phase === 'night' ? 'üåô GECE' : 'üó≥Ô∏è OYLAMA');
            document.getElementById('countdown').innerText = gameState.countdown;

            // Chaos Banner
            const banner = document.getElementById('chaos-banner');
            if (gameState.chaosEvent) {
                banner.innerText = `${gameState.chaosEvent.name}: ${gameState.chaosEvent.desc}`;
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }

            // Grid
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';

            const showingVotes = (gameState.phase === 'voting'); // Or end of vote
            // In voting phase, we usually hide votes until result

            Object.entries(gameState.players).forEach(([id, p]) => {
                const div = document.createElement('div');
                div.className = `vote-card ${p.isAlive ? '' : 'is-dead'}`;
                div.innerHTML = `
                    <div class="player-avatar">${p.name[0]}</div>
                    <div class="player-name">${p.name}</div>
                    ${!p.isAlive ? '<small>üíÄ √ñl√º</small>' : ''}
                 `;

                if (gameState.phase === 'voting' && id !== myPeerId && me.isAlive) {
                    div.onclick = () => castVote(id);
                }
                grid.appendChild(div);
            });

            // Night Panel
            const nightPanel = document.getElementById('night-action-panel');
            const nightRoles = ['vampire', 'doctor', 'seer', 'witch'];
            if (gameState.phase === 'night' && me.isAlive && nightRoles.includes(me.role)) {
                nightPanel.classList.remove('hidden');
                document.getElementById('night-targets').innerHTML = '';

                let title = '', desc = '', action = '';
                if (me.role === 'vampire') { title = 'üßõ AV'; desc = '√ñld√ºr'; action = 'kill'; }
                if (me.role === 'doctor') { title = 'üíâ ƒ∞LKYARDIM'; desc = 'Koru'; action = 'protect'; }
                if (me.role === 'seer') { title = 'üîÆ KEHANET'; desc = 'Sorgula'; action = 'inspect'; }
                if (me.role === 'witch') {
                    title = '‚ú® B√úY√úC√ú';
                    desc = gameState.witchPotions.heal ? 'üíö Kurtarma veya üíÄ Zehir' : (gameState.witchPotions.poison ? 'üíÄ Zehir' : 'ƒ∞ksir kalmadƒ±');
                }

                document.getElementById('night-action-title').innerText = title;
                document.getElementById('night-action-desc').innerText = desc;

                // B√ºy√ºc√º i√ßin √∂zel panel
                if (me.role === 'witch') {
                    const targetsDiv = document.getElementById('night-targets');

                    // Kurtarma iksiri (sadece varsa)
                    if (gameState.witchPotions.heal) {
                        const healBtn = document.createElement('button');
                        healBtn.className = 'btn btn-secondary';
                        healBtn.style.margin = '5px';
                        healBtn.innerHTML = 'üíö Kurtarma ƒ∞ksiri (Vampir kurbanƒ±nƒ± kurtar)';
                        healBtn.onclick = () => {
                            if (isHost) {
                                gameState.nightActions[myPeerId] = { action: 'witch_heal', target: null };
                                gameState.witchPotions.heal = false;
                            } else {
                                sendToHost({ type: 'night_action', action: 'witch_heal', target: null });
                            }
                            nightPanel.classList.add('hidden');
                            showToast('üíö Kurtarma iksiri hazƒ±rlandƒ±!');
                        };
                        targetsDiv.appendChild(healBtn);
                    }

                    // Zehir iksiri (hedef se√ß)
                    if (gameState.witchPotions.poison) {
                        const poisonLabel = document.createElement('p');
                        poisonLabel.innerHTML = '<br>üíÄ Zehir - Hedef Se√ß:';
                        poisonLabel.style.marginTop = '10px';
                        targetsDiv.appendChild(poisonLabel);

                        Object.entries(gameState.players).forEach(([id, p]) => {
                            if (!p.isAlive || id === myPeerId) return;
                            const btn = document.createElement('div');
                            btn.className = 'vote-card';
                            btn.innerHTML = p.name;
                            btn.style.padding = '10px';
                            btn.onclick = () => {
                                if (isHost) {
                                    gameState.nightActions[myPeerId] = { action: 'witch_poison', target: id };
                                    gameState.witchPotions.poison = false;
                                } else {
                                    sendToHost({ type: 'night_action', action: 'witch_poison', target: id });
                                }
                                nightPanel.classList.add('hidden');
                                showToast('üíÄ Zehir verildi!');
                            };
                            targetsDiv.appendChild(btn);
                        });
                    }

                    // Pas ge√ß butonu
                    const skipBtn = document.createElement('button');
                    skipBtn.className = 'btn btn-text';
                    skipBtn.style.marginTop = '15px';
                    skipBtn.innerHTML = 'Bu gece pas ge√ß';
                    skipBtn.onclick = () => {
                        if (isHost) {
                            gameState.nightActions[myPeerId] = { action: 'skip', target: null };
                        } else {
                            sendToHost({ type: 'night_action', action: 'skip', target: null });
                        }
                        nightPanel.classList.add('hidden');
                    };
                    targetsDiv.appendChild(skipBtn);

                } else {
                    // Diƒüer gece rolleri i√ßin normal hedef listesi
                    Object.entries(gameState.players).forEach(([id, p]) => {
                        if (!p.isAlive || id === myPeerId) return;
                        const btn = document.createElement('div');
                        btn.className = 'vote-card';
                        btn.innerHTML = p.name;
                        btn.style.padding = '10px';
                        btn.onclick = () => {
                            if (isHost) {
                                gameState.nightActions[myPeerId] = { action, target: id };
                                if (action === 'inspect') showToast(`${p.name} bir ${p.role === 'vampire' || p.role === 'traitor' ? 'D√ú≈ûMAN' : 'DOST'}`);
                                checkAllNightActions();
                            } else {
                                sendToHost({ type: 'night_action', action, target: id });
                            }
                            nightPanel.classList.add('hidden');
                        };
                        document.getElementById('night-targets').appendChild(btn);
                    });
                }
            } else {
                nightPanel.classList.add('hidden');
            }

            // Dead Controls
            if (!me.isAlive) {
                document.getElementById('dead-controls').classList.remove('hidden');
            } else {
                document.getElementById('dead-controls').classList.add('hidden');
            }

            // Update Alliance UI
            updateAllianceUI();
        }

        function updateLobbyPlayers() {
            const list = document.getElementById('lobby-players');
            list.innerHTML = '';
            Object.values(gameState.players).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerText = p.name;
                list.appendChild(div);
            });
        }

        function getRoleEmoji(role) {
            const map = {
                vampire: 'üßõ',
                villager: 'üë®‚Äçüåæ',
                doctor: 'üíâ',
                seer: 'üîÆ',
                traitor: 'üêÄ',
                hunter: 'üèπ',
                witch: '‚ú®',
                sheriff: '‚≠ê'
            };
            return map[role] || '‚ùì';
        }

        function backToHome() {
            if (peer) peer.destroy();
            location.reload();
        }

        function sendLobbyChat() {
            const inp = document.getElementById('lobby-chat-input');
            const msg = inp.value.trim();
            if (!msg) return;
            const data = { type: 'chat', sender: myUsername, message: msg, chatType: 'lobby' };
            if (isHost) {
                addChatMessage(myUsername, msg, 'lobby');
                broadcast(data);
            } else sendToHost(data);
            inp.value = '';
        }

        function sendGameChat() {
            const inp = document.getElementById('game-chat-input');
            const msg = inp.value.trim();
            if (!msg) return;
            const me = gameState.players[myPeerId];
            const isGhost = !me.isAlive;
            const data = { type: 'chat', sender: myUsername, message: msg, chatType: 'game', isGhost };
            if (isHost) {
                addChatMessage(myUsername, msg, 'game', isGhost);
                broadcast(data);
            } else sendToHost(data);
            inp.value = '';
        }

        function addChatMessage(sender, msg, type, isGhost) {
            const box = document.getElementById(type === 'lobby' ? 'lobby-chat' : 'game-chat');
            const div = document.createElement('div');
            div.className = 'chat-message';
            if (isGhost) div.style.opacity = 0.6;
            div.innerHTML = `${isGhost ? 'üëª ' : ''}<strong style="color:var(--primary-color)">${sender}:</strong> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // Dead Actions
        function haunt(effect) {
            sendToHost({ type: 'haunt', effect });
        }

        function triggerHauntEffect(effect) {
            if (effect === 'vibrate') {
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                document.body.classList.add('shake');
                setTimeout(() => document.body.classList.remove('shake'), 500);
                showToast('üëª Biri seni titretiyor!', 'chaos');
            } else if (effect === 'jumpscare') {
                const ol = document.createElement('div');
                ol.style.position = 'fixed'; ol.style.top = 0; ol.style.left = 0; ol.style.width = '100%'; ol.style.height = '100%';
                ol.style.background = 'white'; ol.style.zIndex = 9999;
                document.body.appendChild(ol);
                setTimeout(() => ol.remove(), 100);
            }
        }

        // Host Helper to determine next phase logic needed
        function checkAllNightActions() {
            // simplified count check
            // In P2P host needs to know who is special.
            // We can check gameState.players roles.
        }

        // Listeners for UI interaction
        function showCreateRoom() { document.getElementById('create-form').classList.remove('hidden'); document.getElementById('join-form').classList.add('hidden'); }
        function showJoinRoom() { document.getElementById('join-form').classList.remove('hidden'); document.getElementById('create-form').classList.add('hidden'); }
        function hideCreateRoom() { document.getElementById('create-form').classList.add('hidden'); }
        function hideJoinRoom() { document.getElementById('join-form').classList.add('hidden'); }
        function leaveLobby() { backToHome(); }

        // ========== ƒ∞TTƒ∞FAK Sƒ∞STEMƒ∞ ==========
        function getMyAlliance() {
            for (const [allianceId, members] of Object.entries(gameState.alliances)) {
                if (members.includes(myPeerId)) return { id: allianceId, members };
            }
            return null;
        }

        function getMyAllianceForPlayer(playerId) {
            for (const [allianceId, members] of Object.entries(gameState.alliances)) {
                if (members.includes(playerId)) return { id: allianceId, members };
            }
            return null;
        }

        function showAllianceInvitePanel() {
            const panel = document.getElementById('alliance-invite-panel');
            const targets = document.getElementById('alliance-invite-targets');
            targets.innerHTML = '';

            Object.entries(gameState.players).forEach(([id, p]) => {
                if (!p.isAlive || id === myPeerId) return;
                // Zaten aynƒ± gruptaysa ekleme
                const myAlliance = getMyAlliance();
                if (myAlliance && myAlliance.members.includes(id)) return;

                const btn = document.createElement('div');
                btn.className = 'vote-card';
                btn.innerHTML = p.name;
                btn.style.padding = '10px';
                btn.style.cursor = 'pointer';
                btn.onclick = () => sendAllianceInvite(id);
                targets.appendChild(btn);
            });

            panel.classList.toggle('hidden');
        }

        function sendAllianceInvite(targetId) {
            const myAlliance = getMyAlliance();
            const allianceId = myAlliance ? myAlliance.id : gameState.nextAllianceId;

            if (isHost) {
                if (!myAlliance) {
                    // Yeni ittifak olu≈ütur
                    gameState.alliances[allianceId] = [myPeerId];
                    gameState.nextAllianceId++;
                }
                gameState.allianceInvites[targetId] = { from: myPeerId, allianceId: allianceId };
                broadcastState();
                showToast('üì® Davet g√∂nderildi!');
            } else {
                sendToHost({ type: 'alliance_invite', target: targetId });
            }
            document.getElementById('alliance-invite-panel').classList.add('hidden');
        }

        function acceptAllianceInvite() {
            const invite = gameState.allianceInvites[myPeerId];
            if (!invite) return;

            if (isHost) {
                // ƒ∞ttifaka katƒ±l
                if (!gameState.alliances[invite.allianceId]) {
                    gameState.alliances[invite.allianceId] = [invite.from];
                }
                gameState.alliances[invite.allianceId].push(myPeerId);
                delete gameState.allianceInvites[myPeerId];
                broadcastState();
                showToast('ü§ù ƒ∞ttifaka katƒ±ldƒ±n!');
            } else {
                sendToHost({ type: 'alliance_accept' });
            }
        }

        function rejectAllianceInvite() {
            if (isHost) {
                delete gameState.allianceInvites[myPeerId];
                broadcastState();
            } else {
                sendToHost({ type: 'alliance_reject' });
            }
            showToast('‚ùå Davet reddedildi');
        }

        function leaveAlliance() {
            const myAlliance = getMyAlliance();
            if (!myAlliance) return;

            if (isHost) {
                const idx = gameState.alliances[myAlliance.id].indexOf(myPeerId);
                if (idx > -1) gameState.alliances[myAlliance.id].splice(idx, 1);
                // Grupta kimse kalmadƒ±ysa sil
                if (gameState.alliances[myAlliance.id].length === 0) {
                    delete gameState.alliances[myAlliance.id];
                }
                broadcastState();
                showToast('üö™ Gruptan ayrƒ±ldƒ±n');
            } else {
                sendToHost({ type: 'alliance_leave' });
            }
        }

        function killAllianceMembers(victimId) {
            // Bir oyuncu √∂ld√ºƒü√ºnde, aynƒ± ittifaktaki herkesi √∂ld√ºr
            if (!gameState.allianceEnabled) return;

            for (const [allianceId, members] of Object.entries(gameState.alliances)) {
                if (members.includes(victimId)) {
                    members.forEach(memberId => {
                        if (gameState.players[memberId] && gameState.players[memberId].isAlive) {
                            gameState.players[memberId].isAlive = false;
                        }
                    });
                    break;
                }
            }
        }

        function updateAllianceUI() {
            if (!gameState.allianceEnabled) {
                document.getElementById('alliance-panel').classList.add('hidden');
                return;
            }

            const me = gameState.players[myPeerId];
            if (!me || !me.isAlive) {
                document.getElementById('alliance-panel').classList.add('hidden');
                return;
            }

            document.getElementById('alliance-panel').classList.remove('hidden');

            const myAlliance = getMyAlliance();
            const statusDiv = document.getElementById('alliance-status');

            if (myAlliance && myAlliance.members.length > 1) {
                const memberNames = myAlliance.members
                    .map(id => gameState.players[id]?.name || '?')
                    .join(', ');
                statusDiv.innerHTML = `<span style="color: #4ade80;">ü§ù Grubun: ${memberNames}</span>`;
                document.getElementById('btn-leave-alliance').classList.remove('hidden');
            } else {
                statusDiv.innerHTML = '<span style="color: rgba(255,255,255,0.5);">Hen√ºz bir grupta deƒüilsin</span>';
                document.getElementById('btn-leave-alliance').classList.add('hidden');
            }

            // Bekleyen davet var mƒ±?
            const invite = gameState.allianceInvites[myPeerId];
            const inviteDiv = document.getElementById('alliance-invite-pending');
            if (invite && gameState.players[invite.from]) {
                document.getElementById('alliance-invite-text').innerText =
                    `${gameState.players[invite.from].name} seni ittifaka davet ediyor!`;
                inviteDiv.classList.remove('hidden');
            } else {
                inviteDiv.classList.add('hidden');
            }
        }

        // Start App
        initApp();
    </script>
</body>

</html>